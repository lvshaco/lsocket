cscope 15 $HOME/lsocket -q 0000000419 0000051222
	@cnet.c

1 
	~"˙ë.h
"

2 
	~"√t.h
"

3 
	~<°dio.h
>

4 
	~<°rög.h
>

5 #i‚de‡
WIN32


6 
	~<¨∑/öë.h
>

7 
	~<sig«l.h
>

9 
	~<wösock2.h
>

12 
√t
* 
	gN
 = 
NULL
;

14 
˙ë_di•©ch
 
	g_di•©ch
 = 
NULL
;

17 
	$˙ë_pﬁl
(
timeout
) {

18 
√t_evít
 *
evíts
;

19 
n
 = 
	`√t_pﬁl
(
N
, 
timeout
, &
evíts
);

20 
i
;

21 
i
=0; i<
n
; ++i) {

22 
√t_evít
 *
evít
 = &
evíts
[
i
];

23 i‡(
evít
->
ty≥
 =
NETE_CONN_THEN_READ
) {

24 
evít
->
ty≥
 = 
NETE_CONNECT
;

25 
	`_di•©ch
(
evít
);

26 
evít
->
ty≥
 = 
NETE_READ
;

27 
	`_di•©ch
(
evít
);

29 
	`_di•©ch
(
evít
);

32  
n
;

33 
	}
}

36 
	$˙ë_£nd
(
id
, *
d©a
, 
sz
) {

37 
√t_evít
 
evít
;

38 
n
 = 
	`√t_£nd
(
N
, 
id
, 
d©a
, 
sz
, &
evít
);

39 i‡(
n
<=0)  0;

40  
evít
.
îr
;

41 
	}
}

44 
	$˙ë_öô
(
cmax
, 
˙ë_di•©ch
 
f
) {

45 #ifde‡
WIN32


46 
WSADATA
 
wd
;

47 
	`WSASèπup
–
	`MAKEWORD
(2, 2Ë, &
wd
);

49 
	`sig«l
(
SIGHUP
, 
SIG_IGN
);

50 
	`sig«l
(
SIGPIPE
, 
SIG_IGN
);

52 
_di•©ch
 = 
f
;

53 
N
 = 
	`√t_¸óã
(
cmax
);

54  !
N
 ? 0:1;

55 
	}
}

58 
	$˙ë_föi
() {

59 i‡(
N
) {

60 
	`√t_‰ì
(
N
);

61 
N
 = 
NULL
;

62 #ifde‡
WIN32


63 
	`WSACÀ™up
();

66 
	}
}

68 
	$˙ë_li°í
(c⁄° *
addr
, 
p‹t
Ë{  
	`√t_li°í
(
N
,addr,p‹t,0); 
	}
}

69 
	$˙ë_c⁄√˘
(c⁄° *
addr
, 
p‹t
Ë{  
	`√t_c⁄√˘
(
N
,addr,p‹t,0,0);
	}
}

70 
	$˙ë_˛o£
(
id
, 
f‹˚
Ë{  
	`√t_˛o£
(
N
,id,f‹˚);
	}
}

71 
	$˙ë_subs¸ibe
(
id
, 
ªad
Ë{  
	`√t_subs¸ibe
(
N
,id,ªad);
	}
}

72 
	$˙ë_ªad
(
id
, **
d©a
Ë{  
	`√t_ªad
(
N
,id,d©a); 
	}
}

73 
	$˙ë_addªss
(
id
, 
√t_addr
 *
addr
Ë{  
	`√t_addªss
(
N
,id,addr); 
	}
}

74 
	$˙ë_¶imô
(
id
, 
¶imô
Ë{  
	`√t_¶imô
(
N
,id,¶imô); 
	}
}

75 
	$˙ë_œ°î∫o
(Ë{  
	`√t_œ°î∫o
(
N
); 
	}
}

76 c⁄° *
	$˙ë_îr‹
(
îr
Ë{  
	`√t_îr‹
(
N
,Éº); 
	}
}

	@cnet.h

1 #i‚de‡
__˙ë_h__


2 
	#__˙ë_h__


	)

4 
	~<°döt.h
>

5 
	~"√t_deföe.h
"

7 (*
	t˙ë_di•©ch
)(
	t√t_evít
 *
	tevít
);

9 
	`˙ë_öô
(
cmax
, 
˙ë_di•©ch
 
f
);

10 
	`˙ë_föi
();

11 
	`˙ë_li°í
(c⁄° *
addr
, 
p‹t
);

12 
	`˙ë_c⁄√˘
(c⁄° *
addr
, 
p‹t
);

13 
	`˙ë_˛o£
(
id
, 
f‹˚
);

14 
	`˙ë_subs¸ibe
(
id
, 
ªad
);

15 
	`˙ë_pﬁl
(
timeout
);

16 
	`˙ë_£nd
(
id
, *
d©a
, 
sz
);

17 
	`˙ë_ªad
(
id
, **
d©a
);

18 
	`˙ë_addªss
(
id
, 
√t_addr
 *
addr
);

19 
	`˙ë_¶imô
(
id
, 
¶imô
);

20 
	`˙ë_œ°î∫o
();

21 c⁄° *
	`˙ë_îr‹
(
îr
);

22 
	#SH_NETERR
 
	`˙ë_îr‹
(
	`˙ë_œ°î∫o
())

	)

	@lsocket.c

1 
	~"˙ë.h
"

2 
	~<lua.h
>

3 
	~<œuxlib.h
>

4 
	~<°dlib.h
>

5 
	~<°rög.h
>

6 
	~<as£π.h
>

7 
	~<°dio.h
>

9 #i‚de‡
NET_LOG


10 
	#NET_LOG
 
¥ötf


	)

12 
	#LOG
 
NET_LOG


	)

14 
lua_Sèã
 *
	g_GL
;

17 
	$_åa˚back
(
lua_Sèã
 *
L
) {

18 c⁄° *
msg
 = 
	`lua_to°rög
(
L
, 1);

19 i‡(
msg
Ë
	`luaL_åa˚back
(
L
, L, msg, 1);

20 
	`lua_pushlôîÆ
(
L
, "(noÉrror message)");

22 
	}
}

25 
	$_di•©ch
(
√t_evít
 *
evít
) {

26 
	`as£π
(
_GL
);

27 
lua_Sèã
 *
L
 = 
_GL
;

28 
	`lua_pushcfun˘i⁄
(
L
,
_åa˚back
);

29 
åa˚
 = 
	`lua_gët›
(
L
);

30 
	`lua_øwgëp
(
L
,
LUA_REGISTRYINDEX
,
_di•©ch
);

31 
	`lua_pushöãgî
(
L
,
evít
->
id
);

32 
	`lua_pushöãgî
(
L
,
evít
->
ty≥
);

33 
	`lua_pushöãgî
(
L
,
evít
->
îr
);

34 
r
 = 
	`lua_pˇŒ
(
L
,3,0,
åa˚
);

35 i‡(
r
 !
LUA_OK
) {

36 
	`LOG
("√àdi•©chÉº‹: %s", 
	`lua_to°rög
(
L
,-1));

37 
	`lua_p›
(
L
,2);

39 
	`lua_p›
(
L
,1);

41 
	}
}

44 
	$löô
(
lua_Sèã
 *
L
) {

45 
cmax
 = 
	`luaL_checköãgî
(
L
,1);

46 
	`luaL_checkty≥
(
L
,2,
LUA_TFUNCTION
);

47 
	`lua_øw£ç
(
L
,
LUA_REGISTRYINDEX
,
_di•©ch
);

49 
	`lua_øwgëi
(
L
,
LUA_REGISTRYINDEX
,
LUA_RIDX_MAINTHREAD
);

50 
_GL
 = 
	`lua_tŸhªad
(
L
,-1);

52 i‡(
	`˙ë_öô
(
cmax
, 
_di•©ch
) == 0) {

53 
	`lua_pushboﬁón
(
L
,1);

56 
	`lua_pushnû
(
L
);

57 
	`lua_pushlôîÆ
(
L
,"net init fail");

60 
	}
}

63 
	$lföi
(
lua_Sèã
 *
L
) {

64 
	`˙ë_föi
();

66 
	}
}

69 
	$Œi°í
(
lua_Sèã
 *
L
) {

70 c⁄° *
ù
 = 
	`luaL_check°rög
(
L
, 1);

71 
p‹t
 = 
	`luaL_checköãgî
(
L
, 2);

72 
id
 = 
	`˙ë_li°í
(
ù
, 
p‹t
);

73 i‡(
id
 >= 0) {

74 
	`lua_pushöãgî
(
L
, 
id
);

77 
	`lua_pushnû
(
L
);

78 
	`lua_push°rög
(
L
, 
SH_NETERR
);

81 
	}
}

84 
	$lc⁄√˘
(
lua_Sèã
 *
L
) {

85 c⁄° *
ù
 = 
	`luaL_check°rög
(
L
, 1);

86 
p‹t
 = 
	`luaL_checköãgî
(
L
, 2);

87 
id
 = 
	`˙ë_c⁄√˘
(
ù
, 
p‹t
);

88 i‡(
id
 >= 0) {

89 i‡(
	`˙ë_œ°î∫o
(Ë=
NET_CONNECTING
) {

90 
	`lua_pushöãgî
(
L
,
id
);

91 
	`lua_pushnû
(
L
);

92 
	`lua_pushboﬁón
(
L
,1);

95 
	`lua_pushöãgî
(
L
,
id
);

99 
	`lua_pushnû
(
L
);

100 
	`lua_pushöãgî
(
L
,
	`˙ë_œ°î∫o
());

103 
	}
}

106 
	$Ãecv
(
lua_Sèã
 *
L
) {

107 
id
 = 
	`luaL_checköãgî
(
L
, 1);

108 *
d©a
;

109 
n
 = 
	`˙ë_ªad
(
id
, &
d©a
);

110 i‡(
n
 > 0) {

111 
	`lua_pushlightu£rd©a
(
L
, 
d©a
);

112 
	`lua_pushöãgî
(
L
, 
n
);

114 } i‡(
n
 == 0) {

115 
	`lua_pushnû
(
L
);

116 
	`lua_pushöãgî
(
L
, 0);

119 
	`lua_pushnû
(
L
);

120 
	`lua_pushöãgî
(
L
, -1);

123 
	}
}

126 
	$l£nd
(
lua_Sèã
 *
L
) {

127 
id
 = 
	`luaL_checköãgî
(
L
,1);

128 *
msg
=
NULL
;

129 
sz
;

130 
ty≥
 = 
	`lua_ty≥
(
L
,2);

131 
ty≥
) {

132 
LUA_TLIGHTUSERDATA
:

133 
msg
 = 
	`lua_tou£rd©a
(
L
,2);

134 
sz
 = 
	`luaL_checköãgî
(
L
,3);

136 
LUA_TSTRING
: {

137 
size_t
 
l
;

138 c⁄° *
s
 = 
	`luaL_checkl°rög
(
L
,2,&
l
);

139 
°¨t
 = 
	`luaL_›töãgî
(
L
, 3, 1);

140 
íd
 = 
	`luaL_›töãgî
(
L
, 4, 
l
);

141 i‡(
°¨t
 < 1) start = 1;

142 i‡(
íd
 > 
l
)Énd =Ü;

143 i‡(
°¨t
 > 
íd
) {

144 
	`lua_pushboﬁón
(
L
, 0);

147 
sz
 = 
íd
-
°¨t
+1;

148 
msg
 = 
	`mÆloc
(
sz
);

149 
	`mem˝y
(
msg
, 
s
+
°¨t
-1, 
sz
);

152  
	`luaL_¨gîr‹
(
L
, 2, "invalidÅype");

154 
îr
 = 
	`˙ë_£nd
(
id
,
msg
,
sz
);

155 i‡(
îr
 !0Ë
	`lua_pushöãgî
(
L
,err);

156 
	`lua_pushnû
(
L
);

158 
	}
}

161 
	$l˛o£
(
lua_Sèã
 *
L
) {

162 
id
 = 
	`luaL_checköãgî
(
L
, 1);

163 
f‹˚
 = 
	`lua_toboﬁón
(
L
, 2);

164 
ok
 = 
	`˙ë_˛o£
(
id
, 
f‹˚
) == 0;

165 
	`lua_pushboﬁón
(
L
, 
ok
);

167 
	}
}

170 
	$ÃódíabÀ
(
lua_Sèã
 *
L
) {

171 
id
 = 
	`luaL_checköãgî
(
L
, 1);

172 
íabÀ
 = 
	`lua_toboﬁón
(
L
, 2);

173 
	`˙ë_subs¸ibe
(
id
, 
íabÀ
);

175 
	}
}

178 
	$œddªss
(
lua_Sèã
 *
L
) {

179 
√t_addr
 
addr
;

180 
id
 = 
	`luaL_checköãgî
(
L
, 1);

181 i‡(!
	`˙ë_addªss
(
id
, &
addr
)) {

182 
	`lua_push°rög
(
L
, 
addr
.
ù
);

183 
	`lua_pushöãgî
(
L
, 
addr
.
p‹t
);

186 
	`lua_pushnû
(
L
);

189 
	}
}

192 
	$l¶imô
(
lua_Sèã
 *
L
) {

193 
id
 = 
	`luaL_checköãgî
(
L
, 1);

194 
¶imô
 = 
	`luaL_checköãgî
(
L
, 2);

195 
	`˙ë_¶imô
(
id
, 
¶imô
);

197 
	}
}

200 
	$Àº‹
(
lua_Sèã
 *
L
) {

201 i‡(
	`lua_gët›
(
L
) == 0)

202 
	`lua_push°rög
(
L
, 
SH_NETERR
);

204 
îr
 = 
	`luaL_checköãgî
(
L
, 1);

205 
	`lua_push°rög
(
L
, 
	`˙ë_îr‹
(
îr
));

208 
	}
}

212 
	sbuf„r_node
 {

213 *
	mp
;

214 
	msz
;

215 
buf„r_node
 *
	m√xt
;

218 
	ssockë_buf„r
 {

219 
	msize
;

220 
	moff£t
;

221 
buf„r_node
 *
	mhód
;

222 
buf„r_node
 *
	mèû
;

226 
	$ ewbuf„r
(
lua_Sèã
 *
L
) {

227 
sockë_buf„r
 *
sb
 = 
	`lua_√wu£rd©a
(
L
, (*sb));

228 
sb
->
size
 = 0;

229 
sb
->
off£t
 = 0;

230 
sb
->
hód
 = 
NULL
;

231 
sb
->
èû
 = 
NULL
;

233 
	}
}

236 
	$Õush
(
lua_Sèã
 *
L
) {

237 
	`luaL_checkty≥
(
L
, 1, 
LUA_TUSERDATA
);

238 
sockë_buf„r
 *
sb
 = 
	`lua_tou£rd©a
(
L
, 1);

239 
	`luaL_checkty≥
(
L
, 2, 
LUA_TLIGHTUSERDATA
);

240 *
p
 = 
	`lua_tou£rd©a
(
L
, 2);

241 
sz
 = 
	`luaL_checköãgî
(
L
, 3);

242 i‡(!
p
 || 
sz
 <= 0) {

245 
buf„r_node
 *
node
 = 
	`mÆloc
((*node));

246 
node
->
p
 =Ö;

247 
node
->
sz
 = sz;

248 
node
->
√xt
 = 
NULL
;

249 i‡(
sb
->
hód
 =
NULL
) {

250 
sb
->
hód
 = 
node
;

251 
sb
->
èû
 = 
node
;

253 
	`as£π
(
sb
->
èû
);

254 
sb
->
èû
->
√xt
 = 
node
;

255 
sb
->
èû
 = 
node
;

257 
sb
->
size
 +
sz
;

259 
	}
}

262 
	$push∑ckp
(
lua_Sèã
 *
L
,

263 
sockë_buf„r
 *
sb
, 
n
,

264 
buf„r_node
 *
node
, 
íd
) {

265 *
∑ck
 = 
	`mÆloc
(
n
);

266 *
p
 = 
∑ck
;

267 
buf„r_node
 *
cuºít
 = 
sb
->
hód
;

268 
off£t
 = 
sb
->off£t, 
diff
;

269 
cuºít
 !
node
) {

270 
diff
 = 
cuºít
->
sz
-
off£t
;

271 
	`mem˝y
(
p
, 
cuºít
->p+
off£t
, 
diff
);

272 
p
 +
diff
;

273 
cuºít
 = cuºít->
√xt
;

274 
off£t
 = 0;

276 
diff
 = 
íd
-
off£t
;

277 
	`mem˝y
(
p
, 
cuºít
->p+
off£t
, 
diff
);

278 
p
 +
diff
;

279 
	`as£π
(
p
-
∑ck
 =
n
);

280 
	`lua_pushlightu£rd©a
(
L
, 
∑ck
);

281 
	`lua_pushöãgî
(
L
, 
n
);

282 
	}
}

285 
	$push∑ck
(
lua_Sèã
 *
L
,

286 
sockë_buf„r
 *
sb
,

287 
buf„r_node
 *
node
, 
íd
) {

288 
luaL_Buf„r
 
b
;

289 
	`luaL_bufföô
(
L
, &
b
);

290 
buf„r_node
 *
cuºít
 = 
sb
->
hód
;

291 
off£t
 = 
sb
->offset;

292 
cuºít
 !
node
) {

293 
	`luaL_addl°rög
(&
b
, 
cuºít
->
p
+
off£t
, cuºít->
sz
-offset);

294 
cuºít
 = cuºít->
√xt
;

295 
off£t
 = 0;

297 
	`luaL_addl°rög
(&
b
, 
cuºít
->
p
+
off£t
, 
íd
-offset);

298 
	`luaL_pushªsu…
(&
b
);

299 
	}
}

302 
	$‰ìbuf„r
(
sockë_buf„r
 *
sb
,

303 
buf„r_node
 *
node
, 
íd
) {

304 
sb
->
size
 +sb->
off£t
;

305 
buf„r_node
 *
tmp
;

307 i‡(
sb
->
hód
 =
node
) {

308 i‡(
node
->
sz
 =
íd
) {

309 
sb
->
hód
 = sb->hód->
√xt
;

310 
sb
->
size
 -
node
->
sz
;

311 
sb
->
off£t
 = 0;

312 
	`‰ì
(
node
->
p
);

313 
	`‰ì
(
node
);

315 
sb
->
size
 -
íd
;

316 
sb
->
off£t
 = 
íd
;

320 
tmp
 = 
sb
->
hód
;

321 
sb
->
hód
 = sb->hód->
√xt
;

322 
sb
->
size
 -
tmp
->
sz
;

323 
	`‰ì
(
tmp
->
p
);

324 
	`‰ì
(
tmp
);

327 
	}
}

329 
buf„r_node
 *

330 
	$check£p
(
buf„r_node
 *
node
,

331 
off£t
,

332 c⁄° *
£p
, 
l
, *
íd
) {

333 
n
=0;

335 
sz
 = 
node
->sz-
off£t
;

336 i‡(
sz
 > 
l
)

337 
sz
 = 
l
;

338 i‡(
	`memcmp
(
node
->
p
+
off£t
, 
£p
+
n
, 
sz
))

339  
NULL
;

340 
n
 +
sz
;

341 i‡(
n
>=
l
) {

342 *
íd
 = 
off£t
+
sz
;

343  
node
;

345 
off£t
 = 0;

346 
node
 =Çode->
√xt
;

347 } 
node
);

348  
NULL
;

349 
	}
}

352 
	$ªad£p
(
lua_Sèã
 *
L
,

353 
sockë_buf„r
 *
sb
,

354 c⁄° *
£p
, 
l
) {

355 
buf„r_node
 *
cuºít
 = 
sb
->
hód
;

356 
buf„r_node
 *
íd_node
;

357 
off£t
 = 
sb
->offset;

358 
íd
, 
i
;

359 
cuºít
) {

360 
i
=
off£t
; i<
cuºít
->
sz
; ++i) {

361 
íd_node
 = 
	`check£p
(
cuºít
, 
i
, 
£p
, 
l
, &
íd
);

362 i‡(
íd_node
) {

363 
	`push∑ck
(
L
, 
sb
, 
cuºít
, 
i
);

364 
	`‰ìbuf„r
(
sb
, 
íd_node
, 
íd
);

368 
cuºít
 = cuºít->
√xt
;

369 
off£t
 = 0;

371 
	`lua_pushnû
(
L
);

373 
	}
}

376 
	$ªadÆl
(
lua_Sèã
 *
L
,

377 
sockë_buf„r
 *
sb
) {

378 i‡(
sb
->
hód
) {

379 
buf„r_node
 *
node
 = 
sb
->
èû
;

380 
	`push∑ck
(
L
, 
sb
, 
node
,Çode->
sz
);

381 
	`‰ìbuf„r
(
sb
, 
node
,Çode->
sz
);

382 
	`as£π
(
sb
->
size
 == 0);

383 
	`as£π
(
sb
->
off£t
 == 0);

386 
	`lua_pushnû
(
L
);

389 
	}
}

392 
	$ªadhód
(
lua_Sèã
 *
L
,

393 
sockë_buf„r
 *
sb
, 
n
) {

394 
	`as£π
(
n
 > 0);

395 i‡(
sb
->
size
 < 
n
) {

396 
	`lua_pushnû
(
L
);

399 
uöt32_t
 
hód
 = 0;

400 
buf„r_node
 *
cuºít
 = 
sb
->
hód
;

401 
off£t
 = 
sb
->offset;

402 
i
=0, 
o
;

403 
cuºít
) {

404 
o
=
off£t
; o<
cuºít
->
sz
; ++o) {

405 
hód
 |((
uöt8_t
*)
cuºít
->
p
)[
o
]<<((
i
++)*8);

406 i‡(
i
>=
n
) {

407 
	`‰ìbuf„r
(
sb
, 
cuºít
, 
o
+1);

408 
	`lua_pushunsig√d
(
L
, 
hód
);

412 
cuºít
 = cuºít->
√xt
;

413 
off£t
 = 0;

415 
	`lua_pushnû
(
L
);

417 
	}
}

420 
	$ªadn
(
lua_Sèã
 *
L
,

421 
sockë_buf„r
 *
sb
, 
n
) {

422 i‡(
n
==0) {

423 
	`lua_pushlôîÆ
(
L
, "");

426 i‡(
sb
->
size
 < 
n
) {

427 
	`lua_pushnû
(
L
);

430 
buf„r_node
 *
cuºít
 = 
sb
->
hód
;

431 
off£t
 = 
sb
->offset;

432 
sz
 = 0;

433 
cuºít
) {

434 
sz
 +
cuºít
->sz-
off£t
;

435 i‡(
sz
 >
n
) {

436 
íd
 = 
cuºít
->
sz
-(sz-
n
);

437 
	`push∑ck
(
L
, 
sb
, 
cuºít
, 
íd
);

438 
	`‰ìbuf„r
(
sb
, 
cuºít
, 
íd
);

441 
cuºít
 = cuºít->
√xt
;

442 
off£t
 = 0;

444 
	`lua_pushnû
(
L
);

446 
	}
}

449 
	$ªad≈
(
lua_Sèã
 *
L
,

450 
sockë_buf„r
 *
sb
, 
n
) {

451 i‡(
n
==0) {

452 
	`lua_pushlightu£rd©a
(
L
, 
NULL
);

453 
	`lua_pushöãgî
(
L
, 0);

456 i‡(
sb
->
size
 < 
n
) {

457 
	`lua_pushnû
(
L
);

460 
buf„r_node
 *
cuºít
 = 
sb
->
hód
;

461 
off£t
 = 
sb
->offset;

462 
sz
 = 0;

463 
cuºít
) {

464 
sz
 +
cuºít
->sz-
off£t
;

465 i‡(
sz
 >
n
) {

466 
íd
 = 
cuºít
->
sz
-(sz-
n
);

467 
	`push∑ckp
(
L
, 
sb
, 
n
, 
cuºít
, 
íd
);

468 
	`‰ìbuf„r
(
sb
, 
cuºít
, 
íd
);

471 
cuºít
 = cuºít->
√xt
;

472 
off£t
 = 0;

474 
	`lua_pushnû
(
L
);

476 
	}
}

479 
	$Õ›
(
lua_Sèã
 *
L
) {

480 
	`luaL_checkty≥
(
L
, 1, 
LUA_TUSERDATA
);

481 
sockë_buf„r
 *
sb
 = 
	`lua_tou£rd©a
(
L
, 1);

482 
«rgs
 = 
	`lua_gët›
(
L
);

483 i‡(
«rgs
 == 1) {

484  
	`ªad£p
(
L
, 
sb
, "\n", 1);

486 
ty≥
 = 
	`lua_ty≥
(
L
, 2);

487 
ty≥
) {

488 
LUA_TSTRING
: {

489 
size_t
 
l
;

490 c⁄° *
p
 = 
	`luaL_checkl°rög
(
L
, 2, &
l
);

491 i‡(
l
>1) {

492 i‡(
p
[0] == '*') {

493 
p
[1]) {

494 '1':  
	`ªadhód
(
L
, 
sb
, 1);

495 '2':  
	`ªadhód
(
L
, 
sb
, 2);

496 '4':  
	`ªadhód
(
L
, 
sb
, 4);

497 'a':  
	`ªadÆl
(
L
, 
sb
);

498 'l':  
	`ªad£p
(
L
, 
sb
, "\n", 1);

500  
	`luaL_¨gîr‹
(
L
, 2, "invalid mode");

503  
	`ªad£p
(
L
, 
sb
, 
p
, 
l
);

505 } i‡(
l
==1) {

506  
	`ªad£p
(
L
, 
sb
, 
p
, 
l
);

508  
	`luaL_¨gîr‹
(
L
, 2, "invalid mode");

510 
LUA_TNUMBER
: {

511 
uöt32_t
 
n
 = 
	`luaL_checkunsig√d
(
L
, 2);

512  
	`ªadn
(
L
, 
sb
, 
n
);

515  
	`luaL_¨gîr‹
(
L
, 2, "invalid format");

518 
	}
}

521 
	$Õ›byãs
(
lua_Sèã
 *
L
) {

522 
	`luaL_checkty≥
(
L
, 1, 
LUA_TUSERDATA
);

523 
sockë_buf„r
 *
sb
 = 
	`lua_tou£rd©a
(
L
, 1);

524 
uöt32_t
 
n
 = 
	`luaL_checkunsig√d
(
L
, 2);

525  
	`ªad≈
(
L
, 
sb
, 
n
);

526 
	}
}

529 
	$l‰ìbyãs
(
lua_Sèã
 *
L
) {

530 
	`luaL_checkty≥
(
L
,1,
LUA_TLIGHTUSERDATA
);

531 *
p
 = 
	`lua_tou£rd©a
(
L
,1);

532 
	`‰ì
(
p
);

534 
	}
}

537 
	$lua›í_sockë_c
(
lua_Sèã
 *
L
) {

538 
	`luaL_checkvîsi⁄
(
L
);

539 
luaL_Reg
 
l
[] = {

540 {"öô", 
löô
},

541 {"föi", 
lföi
},

542 {"li°í", 
Œi°í
},

543 {"c⁄√˘", 
lc⁄√˘
},

544 {"˛o£", 
l˛o£
},

545 {"ªcv", 
Ãecv
},

546 {"£nd", 
l£nd
},

547 {"ªadíabÀ", 
ÃódíabÀ
},

548 {"addªss", 
œddªss
},

549 {"¶imô", 
l¶imô
},

550 {"îr‹", 
Àº‹
},

551 {
NULL
, NULL},

553 
luaL_Reg
 
l2
[] = {

554 {"√wbuf„r", 
 ewbuf„r
},

555 {"push", 
Õush
},

556 {"p›", 
Õ›
},

557 {"p›byãs", 
Õ›byãs
},

558 {"‰ìbyãs", 
l‰ìbyãs
 },

559 {
NULL
, NULL},

561 
	`luaL_√wlibèbÀ
(
L
, 
l
);

562 
	`luaL_£tfuncs
(
L
,
l
,0);

563 
	`luaL_£tfuncs
(
L
,
l2
,0);

565 
	}
}

	@lsocket_buffer.c

1 
	~"˙ë.h
"

2 
	~<lua.h
>

3 
	~<œuxlib.h
>

4 
	~<°dlib.h
>

5 
	~<°rög.h
>

6 
	~<as£π.h
>

7 
	~<°dio.h
>

9 #i‚de‡
NET_LOG


10 
	#NET_LOG
 
¥ötf


	)

12 
	#LOG
 
NET_LOG


	)

14 
lua_Sèã
 *
	g_GL
;

17 
	$_åa˚back
(
lua_Sèã
 *
L
) {

18 c⁄° *
msg
 = 
	`lua_to°rög
(
L
, 1);

19 i‡(
msg
Ë
	`luaL_åa˚back
(
L
, L, msg, 1);

20 
	`lua_pushlôîÆ
(
L
, "(noÉrror message)");

22 
	}
}

25 
	$_di•©ch
(
√t_evít
 *
evít
) {

26 
	`as£π
(
_GL
);

27 
lua_Sèã
 *
L
 = 
_GL
;

28 
	`lua_pushcfun˘i⁄
(
L
,
_åa˚back
);

29 
åa˚
 = 
	`lua_gët›
(
L
);

30 
	`lua_øwgëp
(
L
,
LUA_REGISTRYINDEX
,
_di•©ch
);

31 
	`lua_pushöãgî
(
L
,
evít
->
id
);

32 
	`lua_pushöãgî
(
L
,
evít
->
ty≥
);

33 
	`lua_pushöãgî
(
L
,
evít
->
îr
);

34 
r
 = 
	`lua_pˇŒ
(
L
,3,0,
åa˚
);

35 i‡(
r
 !
LUA_OK
) {

36 
	`LOG
("√àdi•©chÉº‹: %s", 
	`lua_to°rög
(
L
,-1));

37 
	`lua_p›
(
L
,2);

39 
	`lua_p›
(
L
,1);

41 
	}
}

44 
	$löô
(
lua_Sèã
 *
L
) {

45 
cmax
 = 
	`luaL_checköãgî
(
L
,1);

46 
	`luaL_checkty≥
(
L
,2,
LUA_TFUNCTION
);

47 
	`lua_øw£ç
(
L
,
LUA_REGISTRYINDEX
,
_di•©ch
);

49 
	`lua_øwgëi
(
L
,
LUA_REGISTRYINDEX
,
LUA_RIDX_MAINTHREAD
);

50 
_GL
 = 
	`lua_tŸhªad
(
L
,-1);

52 i‡(
	`˙ë_öô
(
cmax
, 
_di•©ch
) == 0) {

53 
	`lua_pushboﬁón
(
L
,1);

56 
	`lua_pushnû
(
L
);

57 
	`lua_pushlôîÆ
(
L
,"net init fail");

60 
	}
}

63 
	$lföi
(
lua_Sèã
 *
L
) {

64 
	`˙ë_föi
();

66 
	}
}

69 
	$Œi°í
(
lua_Sèã
 *
L
) {

70 c⁄° *
ù
 = 
	`luaL_check°rög
(
L
, 1);

71 
p‹t
 = 
	`luaL_checköãgî
(
L
, 2);

72 
id
 = 
	`˙ë_li°í
(
ù
, 
p‹t
);

73 i‡(
id
 >= 0) {

74 
	`lua_pushöãgî
(
L
, 
id
);

77 
	`lua_pushnû
(
L
);

78 
	`lua_push°rög
(
L
, 
SH_NETERR
);

81 
	}
}

84 
	$lc⁄√˘
(
lua_Sèã
 *
L
) {

85 c⁄° *
ù
 = 
	`luaL_check°rög
(
L
, 1);

86 
p‹t
 = 
	`luaL_checköãgî
(
L
, 2);

87 
id
 = 
	`˙ë_c⁄√˘
(
ù
, 
p‹t
);

88 i‡(
id
 >= 0) {

89 i‡(
	`˙ë_œ°î∫o
(Ë=
NET_CONNECTING
) {

90 
	`lua_pushöãgî
(
L
,
id
);

91 
	`lua_pushnû
(
L
);

92 
	`lua_pushboﬁón
(
L
,1);

95 
	`lua_pushöãgî
(
L
,
id
);

99 
	`lua_pushnû
(
L
);

100 
	`lua_pushöãgî
(
L
,
	`˙ë_œ°î∫o
());

103 
	}
}

106 
	$Ãecv
(
lua_Sèã
 *
L
) {

107 
id
 = 
	`luaL_checköãgî
(
L
, 1);

108 *
d©a
;

109 
n
 = 
	`˙ë_ªad
(
id
, &
d©a
);

110 i‡(
n
 > 0) {

111 
	`lua_pushlightu£rd©a
(
L
, 
d©a
);

112 
	`lua_pushöãgî
(
L
, 
n
);

114 } i‡(
n
 == 0) {

115 
	`lua_pushnû
(
L
);

116 
	`lua_pushöãgî
(
L
, 0);

119 
	`lua_pushnû
(
L
);

120 
	`lua_pushöãgî
(
L
, -1);

123 
	}
}

126 
	$l£nd
(
lua_Sèã
 *
L
) {

127 
id
 = 
	`luaL_checköãgî
(
L
,1);

128 *
msg
=
NULL
;

129 
sz
;

130 
ty≥
 = 
	`lua_ty≥
(
L
,2);

131 
ty≥
) {

132 
LUA_TLIGHTUSERDATA
:

133 
msg
 = 
	`lua_tou£rd©a
(
L
,2);

134 
sz
 = 
	`luaL_checköãgî
(
L
,3);

136 
LUA_TSTRING
: {

137 
size_t
 
l
;

138 c⁄° *
s
 = 
	`luaL_checkl°rög
(
L
,2,&
l
);

139 
°¨t
 = 
	`luaL_›töãgî
(
L
, 3, 1);

140 
íd
 = 
	`luaL_›töãgî
(
L
, 4, 
l
);

141 i‡(
°¨t
 < 1) start = 1;

142 i‡(
íd
 > 
l
)Énd =Ü;

143 i‡(
°¨t
 > 
íd
) {

144 
	`lua_pushboﬁón
(
L
, 0);

147 
sz
 = 
íd
-
°¨t
+1;

148 
msg
 = 
	`mÆloc
(
sz
);

149 
	`mem˝y
(
msg
, 
s
+
°¨t
-1, 
sz
);

152  
	`luaL_¨gîr‹
(
L
, 2, "invalidÅype");

154 
îr
 = 
	`˙ë_£nd
(
id
,
msg
,
sz
);

155 i‡(
îr
 !0Ë
	`lua_pushöãgî
(
L
,err);

156 
	`lua_pushnû
(
L
);

158 
	}
}

161 
	$l˛o£
(
lua_Sèã
 *
L
) {

162 
id
 = 
	`luaL_checköãgî
(
L
, 1);

163 
f‹˚
 = 
	`lua_toboﬁón
(
L
, 2);

164 
ok
 = 
	`˙ë_˛o£
(
id
, 
f‹˚
) == 0;

165 
	`lua_pushboﬁón
(
L
, 
ok
);

167 
	}
}

170 
	$ÃódíabÀ
(
lua_Sèã
 *
L
) {

171 
id
 = 
	`luaL_checköãgî
(
L
, 1);

172 
íabÀ
 = 
	`lua_toboﬁón
(
L
, 2);

173 
	`˙ë_subs¸ibe
(
id
, 
íabÀ
);

175 
	}
}

178 
	$œddªss
(
lua_Sèã
 *
L
) {

179 
√t_addr
 
addr
;

180 
id
 = 
	`luaL_checköãgî
(
L
, 1);

181 i‡(!
	`˙ë_addªss
(
id
, &
addr
)) {

182 
	`lua_push°rög
(
L
, 
addr
.
ù
);

183 
	`lua_pushöãgî
(
L
, 
addr
.
p‹t
);

186 
	`lua_pushnû
(
L
);

189 
	}
}

192 
	$l¶imô
(
lua_Sèã
 *
L
) {

193 
id
 = 
	`luaL_checköãgî
(
L
, 1);

194 
¶imô
 = 
	`luaL_checköãgî
(
L
, 2);

195 
	`˙ë_¶imô
(
id
, 
¶imô
);

197 
	}
}

200 
	$Àº‹
(
lua_Sèã
 *
L
) {

201 i‡(
	`lua_gët›
(
L
) == 0)

202 
	`lua_push°rög
(
L
, 
SH_NETERR
);

204 
îr
 = 
	`luaL_checköãgî
(
L
, 1);

205 
	`lua_push°rög
(
L
, 
	`˙ë_îr‹
(
îr
));

208 
	}
}

212 
	sbuf„r_node
 {

213 *
	mp
;

214 
	msz
;

215 
buf„r_node
 *
	m√xt
;

218 
	ssockë_buf„r
 {

219 
	msize
;

220 
	moff£t
;

221 
buf„r_node
 *
	mhód
;

222 
buf„r_node
 *
	mèû
;

226 
	$ ewbuf„r
(
lua_Sèã
 *
L
) {

227 
sockë_buf„r
 *
sb
 = 
	`lua_√wu£rd©a
(
L
, (*sb));

228 
sb
->
size
 = 0;

229 
sb
->
off£t
 = 0;

230 
sb
->
hód
 = 
NULL
;

231 
sb
->
èû
 = 
NULL
;

233 
	}
}

236 
	$Õush
(
lua_Sèã
 *
L
) {

237 
	`luaL_checkty≥
(
L
, 1, 
LUA_TUSERDATA
);

238 
sockë_buf„r
 *
sb
 = 
	`lua_tou£rd©a
(
L
, 1);

239 
	`luaL_checkty≥
(
L
, 2, 
LUA_TLIGHTUSERDATA
);

240 *
p
 = 
	`lua_tou£rd©a
(
L
, 2);

241 
sz
 = 
	`luaL_checköãgî
(
L
, 3);

242 i‡(!
p
 || 
sz
 <= 0) {

245 
buf„r_node
 *
node
 = 
	`mÆloc
((*node));

246 
node
->
p
 =Ö;

247 
node
->
sz
 = sz;

248 
node
->
√xt
 = 
NULL
;

249 i‡(
sb
->
hód
 =
NULL
) {

250 
sb
->
hód
 = 
node
;

251 
sb
->
èû
 = 
node
;

253 
	`as£π
(
sb
->
èû
);

254 
sb
->
èû
->
√xt
 = 
node
;

255 
sb
->
èû
 = 
node
;

257 
sb
->
size
 +
sz
;

259 
	}
}

262 
	$push∑ckp
(
lua_Sèã
 *
L
,

263 
sockë_buf„r
 *
sb
, 
n
,

264 
buf„r_node
 *
node
, 
íd
) {

265 *
∑ck
 = 
	`mÆloc
(
n
);

266 *
p
 = 
∑ck
;

267 
buf„r_node
 *
cuºít
 = 
sb
->
hód
;

268 
off£t
 = 
sb
->off£t, 
diff
;

269 
cuºít
 !
node
) {

270 
diff
 = 
cuºít
->
sz
-
off£t
;

271 
	`mem˝y
(
p
, 
cuºít
->p+
off£t
, 
diff
);

272 
p
 +
diff
;

273 
cuºít
 = cuºít->
√xt
;

274 
off£t
 = 0;

276 
diff
 = 
íd
-
off£t
;

277 
	`mem˝y
(
p
, 
cuºít
->p+
off£t
, 
diff
);

278 
p
 +
diff
;

279 
	`as£π
(
p
-
∑ck
 =
n
);

280 
	`lua_pushlightu£rd©a
(
L
, 
∑ck
);

281 
	`lua_pushöãgî
(
L
, 
n
);

282 
	}
}

285 
	$push∑ck
(
lua_Sèã
 *
L
,

286 
sockë_buf„r
 *
sb
,

287 
buf„r_node
 *
node
, 
íd
) {

288 
luaL_Buf„r
 
b
;

289 
	`luaL_bufföô
(
L
, &
b
);

290 
buf„r_node
 *
cuºít
 = 
sb
->
hód
;

291 
off£t
 = 
sb
->offset;

292 
cuºít
 !
node
) {

293 
	`luaL_addl°rög
(&
b
, 
cuºít
->
p
+
off£t
, cuºít->
sz
-offset);

294 
cuºít
 = cuºít->
√xt
;

295 
off£t
 = 0;

297 
	`luaL_addl°rög
(&
b
, 
cuºít
->
p
+
off£t
, 
íd
-offset);

298 
	`luaL_pushªsu…
(&
b
);

299 
	}
}

302 
	$‰ìbuf„r
(
sockë_buf„r
 *
sb
,

303 
buf„r_node
 *
node
, 
íd
) {

304 
sb
->
size
 +sb->
off£t
;

305 
buf„r_node
 *
tmp
;

307 i‡(
sb
->
hód
 =
node
) {

308 i‡(
node
->
sz
 =
íd
) {

309 
sb
->
hód
 = sb->hód->
√xt
;

310 
sb
->
size
 -
node
->
sz
;

311 
sb
->
off£t
 = 0;

312 
	`‰ì
(
node
->
p
);

313 
	`‰ì
(
node
);

315 
sb
->
size
 -
íd
;

316 
sb
->
off£t
 = 
íd
;

320 
tmp
 = 
sb
->
hód
;

321 
sb
->
hód
 = sb->hód->
√xt
;

322 
sb
->
size
 -
tmp
->
sz
;

323 
	`‰ì
(
tmp
->
p
);

324 
	`‰ì
(
tmp
);

327 
	}
}

329 
buf„r_node
 *

330 
	$check£p
(
buf„r_node
 *
node
,

331 
off£t
,

332 c⁄° *
£p
, 
l
, *
íd
) {

333 
n
=0;

335 
sz
 = 
node
->sz-
off£t
;

336 i‡(
sz
 > 
l
)

337 
sz
 = 
l
;

338 i‡(
	`memcmp
(
node
->
p
+
off£t
, 
£p
+
n
, 
sz
))

339  
NULL
;

340 
n
 +
sz
;

341 i‡(
n
>=
l
) {

342 *
íd
 = 
off£t
+
sz
;

343  
node
;

345 
off£t
 = 0;

346 
node
 =Çode->
√xt
;

347 } 
node
);

348  
NULL
;

349 
	}
}

352 
	$ªad£p
(
lua_Sèã
 *
L
,

353 
sockë_buf„r
 *
sb
,

354 c⁄° *
£p
, 
l
) {

355 
buf„r_node
 *
cuºít
 = 
sb
->
hód
;

356 
buf„r_node
 *
íd_node
;

357 
off£t
 = 
sb
->offset;

358 
íd
, 
i
;

359 
cuºít
) {

360 
i
=
off£t
; i<
cuºít
->
sz
; ++i) {

361 
íd_node
 = 
	`check£p
(
cuºít
, 
i
, 
£p
, 
l
, &
íd
);

362 i‡(
íd_node
) {

363 
	`push∑ck
(
L
, 
sb
, 
cuºít
, 
i
);

364 
	`‰ìbuf„r
(
sb
, 
íd_node
, 
íd
);

368 
cuºít
 = cuºít->
√xt
;

369 
off£t
 = 0;

371 
	`lua_pushnû
(
L
);

373 
	}
}

376 
	$ªadÆl
(
lua_Sèã
 *
L
,

377 
sockë_buf„r
 *
sb
) {

378 i‡(
sb
->
hód
) {

379 
buf„r_node
 *
node
 = 
sb
->
èû
;

380 
	`push∑ck
(
L
, 
sb
, 
node
,Çode->
sz
);

381 
	`‰ìbuf„r
(
sb
, 
node
,Çode->
sz
);

382 
	`as£π
(
sb
->
size
 == 0);

383 
	`as£π
(
sb
->
off£t
 == 0);

386 
	`lua_pushnû
(
L
);

389 
	}
}

392 
	$ªadhód
(
lua_Sèã
 *
L
,

393 
sockë_buf„r
 *
sb
, 
n
) {

394 
	`as£π
(
n
 > 0);

395 i‡(
sb
->
size
 < 
n
) {

396 
	`lua_pushnû
(
L
);

399 
uöt32_t
 
hód
 = 0;

400 
buf„r_node
 *
cuºít
 = 
sb
->
hód
;

401 
off£t
 = 
sb
->offset;

402 
i
=0, 
o
;

403 
cuºít
) {

404 
o
=
off£t
; o<
cuºít
->
sz
; ++o) {

405 
hód
 |((
uöt8_t
*)
cuºít
->
p
)[
o
]<<((
i
++)*8);

406 i‡(
i
>=
n
) {

407 
	`‰ìbuf„r
(
sb
, 
cuºít
, 
o
+1);

408 
	`lua_pushunsig√d
(
L
, 
hód
);

412 
cuºít
 = cuºít->
√xt
;

413 
off£t
 = 0;

415 
	`lua_pushnû
(
L
);

417 
	}
}

420 
	$ªadn
(
lua_Sèã
 *
L
,

421 
sockë_buf„r
 *
sb
, 
n
) {

422 i‡(
n
==0) {

423 
	`lua_pushlôîÆ
(
L
, "");

426 i‡(
sb
->
size
 < 
n
) {

427 
	`lua_pushnû
(
L
);

430 
buf„r_node
 *
cuºít
 = 
sb
->
hód
;

431 
off£t
 = 
sb
->offset;

432 
sz
 = 0;

433 
cuºít
) {

434 
sz
 +
cuºít
->sz-
off£t
;

435 i‡(
sz
 >
n
) {

436 
íd
 = 
cuºít
->
sz
-(sz-
n
);

437 
	`push∑ck
(
L
, 
sb
, 
cuºít
, 
íd
);

438 
	`‰ìbuf„r
(
sb
, 
cuºít
, 
íd
);

441 
cuºít
 = cuºít->
√xt
;

442 
off£t
 = 0;

444 
	`lua_pushnû
(
L
);

446 
	}
}

449 
	$ªad≈
(
lua_Sèã
 *
L
,

450 
sockë_buf„r
 *
sb
, 
n
) {

451 i‡(
n
==0) {

452 
	`lua_pushlightu£rd©a
(
L
, 
NULL
);

453 
	`lua_pushöãgî
(
L
, 0);

456 i‡(
sb
->
size
 < 
n
) {

457 
	`lua_pushnû
(
L
);

460 
buf„r_node
 *
cuºít
 = 
sb
->
hód
;

461 
off£t
 = 
sb
->offset;

462 
sz
 = 0;

463 
cuºít
) {

464 
sz
 +
cuºít
->sz-
off£t
;

465 i‡(
sz
 >
n
) {

466 
íd
 = 
cuºít
->
sz
-(sz-
n
);

467 
	`push∑ckp
(
L
, 
sb
, 
n
, 
cuºít
, 
íd
);

468 
	`‰ìbuf„r
(
sb
, 
cuºít
, 
íd
);

471 
cuºít
 = cuºít->
√xt
;

472 
off£t
 = 0;

474 
	`lua_pushnû
(
L
);

476 
	}
}

479 
	$Õ›
(
lua_Sèã
 *
L
) {

480 
	`luaL_checkty≥
(
L
, 1, 
LUA_TUSERDATA
);

481 
sockë_buf„r
 *
sb
 = 
	`lua_tou£rd©a
(
L
, 1);

482 
«rgs
 = 
	`lua_gët›
(
L
);

483 i‡(
«rgs
 == 1) {

484  
	`ªad£p
(
L
, 
sb
, "\n", 1);

486 
ty≥
 = 
	`lua_ty≥
(
L
, 2);

487 
ty≥
) {

488 
LUA_TSTRING
: {

489 
size_t
 
l
;

490 c⁄° *
p
 = 
	`luaL_checkl°rög
(
L
, 2, &
l
);

491 i‡(
l
>1) {

492 i‡(
p
[0] == '*') {

493 
p
[1]) {

494 '1':  
	`ªadhód
(
L
, 
sb
, 1);

495 '2':  
	`ªadhód
(
L
, 
sb
, 2);

496 '4':  
	`ªadhód
(
L
, 
sb
, 4);

497 'a':  
	`ªadÆl
(
L
, 
sb
);

498 'l':  
	`ªad£p
(
L
, 
sb
, "\n", 1);

500  
	`luaL_¨gîr‹
(
L
, 2, "invalid mode");

503  
	`ªad£p
(
L
, 
sb
, 
p
, 
l
);

505 } i‡(
l
==1) {

506  
	`ªad£p
(
L
, 
sb
, 
p
, 
l
);

508  
	`luaL_¨gîr‹
(
L
, 2, "invalid mode");

510 
LUA_TNUMBER
: {

511 
uöt32_t
 
n
 = 
	`luaL_checkunsig√d
(
L
, 2);

512  
	`ªadn
(
L
, 
sb
, 
n
);

515  
	`luaL_¨gîr‹
(
L
, 2, "invalid format");

518 
	}
}

521 
	$Õ›byãs
(
lua_Sèã
 *
L
) {

522 
	`luaL_checkty≥
(
L
, 1, 
LUA_TUSERDATA
);

523 
sockë_buf„r
 *
sb
 = 
	`lua_tou£rd©a
(
L
, 1);

524 
uöt32_t
 
n
 = 
	`luaL_checkunsig√d
(
L
, 2);

525  
	`ªad≈
(
L
, 
sb
, 
n
);

526 
	}
}

529 
	$l‰ìbyãs
(
lua_Sèã
 *
L
) {

530 
	`luaL_checkty≥
(
L
,1,
LUA_TLIGHTUSERDATA
);

531 *
p
 = 
	`lua_tou£rd©a
(
L
,1);

532 
	`‰ì
(
p
);

534 
	}
}

537 
	$lua›í_sockë_c
(
lua_Sèã
 *
L
) {

538 
	`luaL_checkvîsi⁄
(
L
);

539 
luaL_Reg
 
l
[] = {

540 {"öô", 
löô
},

541 {"föi", 
lföi
},

542 {"li°í", 
Œi°í
},

543 {"c⁄√˘", 
lc⁄√˘
},

544 {"˛o£", 
l˛o£
},

545 {"ªcv", 
Ãecv
},

546 {"£nd", 
l£nd
},

547 {"ªadíabÀ", 
ÃódíabÀ
},

548 {"addªss", 
œddªss
},

549 {"¶imô", 
l¶imô
},

550 {"îr‹", 
Àº‹
},

551 {
NULL
, NULL},

553 
luaL_Reg
 
l2
[] = {

554 {"√wbuf„r", 
 ewbuf„r
},

555 {"push", 
Õush
},

556 {"p›", 
Õ›
},

557 {"p›byãs", 
Õ›byãs
},

558 {"‰ìbyãs", 
l‰ìbyãs
 },

559 {
NULL
, NULL},

561 
	`luaL_√wlibèbÀ
(
L
, 
l
);

562 
	`luaL_£tfuncs
(
L
,
l
,0);

563 
	`luaL_£tfuncs
(
L
,
l2
,0);

565 
	}
}

	@np.h

1 #i‚de‡
__√çﬁl_h__


2 
	#__√çﬁl_h__


	)

4 
	~<°dboﬁ.h
>

6 
	#NP_RABLE
 1

	)

7 
	#NP_WABLE
 2

	)

9 
	s≈_evít
 {

10 * 
	mud
;

11 
boﬁ
 
	mªad
;

12 
boﬁ
 
	mwrôe
;

15 
	g≈_°©e
;

16 
≈_öô
(
≈_°©e
* 
≈
, 
max
);

17 
≈_föi
(
≈_°©e
* 
≈
);

18 
≈_add
(
≈_°©e
* 
≈
, 
fd
, 
mask
, * 
ud
);

19 
≈_mod
(
≈_°©e
* 
≈
, 
fd
, 
mask
, * 
ud
);

20 
≈_dñ
(
≈_°©e
* 
≈
, 
fd
);

21 
≈_pﬁl
(
≈_°©e
* 
≈
, 
≈_evít
* 
e
, 
max
, 
timeout
);

23 #ifde‡
__löux__


24 
	~"sockë_ïﬁl.h
"

29 
	~"sockë_£À˘.h
"

	@np_epoll.h

1 #i‚de‡
__sockë_ïﬁl_h__


2 
	#__sockë_ïﬁl_h__


	)

4 
	~<sys/ïﬁl.h
>

5 
	~<°dlib.h
>

6 
	~<uni°d.h
>

7 
	~<f˙é.h
>

9 
	s≈_°©e
 {

10 
	mïﬁl_fd
;

11 
ïﬁl_evít
* 
	mev
;

15 
	$≈_öô
(
≈_°©e
* 
≈
, 
max
) {

16 
ïﬁl_fd
 = 
	`ïﬁl_¸óã
(
max
+1);

17 i‡(
ïﬁl_fd
 == -1)

19 
Êag
 = 
	`f˙é
(
ïﬁl_fd
, 
F_GETFD
, 0);

20 i‡(
Êag
 == -1)

22 i‡(
	`f˙é
(
ïﬁl_fd
, 
F_SETFD
, 
Êag
 | 
FD_CLOEXEC
))

24 
≈
->
ïﬁl_fd
 =Époll_fd;

25 
≈
->
ev
 = 
	`mÆloc
((
ïﬁl_evít
Ë* 
max
);

27 
	}
}

30 
	$≈_föi
(
≈_°©e
* 
≈
) {

31 i‡(
≈
->
ev
) {

32 
	`‰ì
(
≈
->
ev
);

33 
≈
->
ev
 = 
NULL
;

35 i‡(
≈
->
ïﬁl_fd
 != -1) {

36 
	`˛o£
(
≈
->
ïﬁl_fd
);

37 
≈
->
ïﬁl_fd
 = -1;

39 
	}
}

41 
ölöe
 

42 
	$_›
(
ïﬁl_fd
, 
fd
, 
›
, 
mask
, * 
ud
) {

43 
ïﬁl_evít
 
e
;

44 
e
.
evíts
 = 0;

45 i‡(
mask
 & 
NP_RABLE
Ë
e
.
evíts
 |
EPOLLIN
;

46 i‡(
mask
 & 
NP_WABLE
Ë
e
.
evíts
 |
EPOLLOUT
;

47 
e
.
d©a
.
±r
 = 
ud
;

48  
	`ïﬁl_˘l
(
ïﬁl_fd
, 
›
, 
fd
, &
e
);

49 
	}
}

52 
	$≈_add
(
≈_°©e
* 
≈
, 
fd
, 
mask
, * 
ud
) {

53  
	`_›
(
≈
->
ïﬁl_fd
, 
fd
, 
EPOLL_CTL_ADD
, 
mask
, 
ud
);

54 
	}
}

57 
	$≈_mod
(
≈_°©e
* 
≈
, 
fd
, 
mask
, * 
ud
) {

58  
	`_›
(
≈
->
ïﬁl_fd
, 
fd
, 
EPOLL_CTL_MOD
, 
mask
, 
ud
);

59 
	}
}

62 
	$≈_dñ
(
≈_°©e
* 
≈
, 
fd
) {

63 
ïﬁl_evít
 
e
;

64 
e
.
evíts
 = 0;

65 
e
.
d©a
.
±r
 = 0;

66  
	`ïﬁl_˘l
(
≈
->
ïﬁl_fd
, 
EPOLL_CTL_DEL
, 
fd
, &
e
);

67 
	}
}

70 
	$≈_pﬁl
(
≈_°©e
* 
≈
, 
≈_evít
* 
e
, 
max
, 
timeout
) {

71 
ïﬁl_evít
* 
ev
 = 
≈
->ev;

72 
i
;

73 
n
 = 
	`ïﬁl_waô
(
≈
->
ïﬁl_fd
, 
ev
, 
max
, 
timeout
);

74 
i
=0; i<
n
; ++i) {

75 
e
[
i
].
ud
 = 
ev
[i].
d©a
.
±r
;

76 
e
[
i
].
ªad
 = (
ev
[i].
evíts
 & 
EPOLLIN
) != 0;

77 
e
[
i
].
wrôe
 = ((
ev
[i].
evíts
 & 
EPOLLOUT
) != 0) ||

78 ((
ev
[
i
].
evíts
 & 
EPOLLERR
) != 0) ||

79 ((
ev
[
i
].
evíts
 & 
EPOLLHUP
) != 0);

81  
n
;

82 
	}
}

	@np_select.h

1 #i‚de‡
__sockë_£À˘_h__


2 
	#__sockë_£À˘_h__


	)

4 
	~<°dlib.h
>

5 
	~<°rög.h
>

6 
	~<as£π.h
>

10 
	s≈_°©e
 {

11 
	mˇp
;

12 ** 
	mud
;

13 
	mmaxfd
;

14 
fd_£t
 
	mrfds
;

15 
fd_£t
 
	mwfds
;

16 
fd_£t
 
	mπmp
;

17 
fd_£t
 
	mwtmp
;

21 
	$≈_öô
(
≈_°©e
* 
≈
, 
max
) {

22 
ˇp
 = 1;

23 
ˇp
 < 
max
)

24 
ˇp
 *= 2;

25 
≈
->
ˇp
 = cap;

26 
≈
->
ud
 = 
	`mÆloc
((*Ë* 
ˇp
);

27 
	`mem£t
(
≈
->
ud
, 0, (*Ë* 
ˇp
);

28 
≈
->
maxfd
 = -1;

29 
	`FD_ZERO
(&
≈
->
rfds
);

30 
	`FD_ZERO
(&
≈
->
wfds
);

32 
	}
}

35 
	$≈_föi
(
≈_°©e
* 
≈
) {

36 
	`FD_ZERO
(&
≈
->
rfds
);

37 
	`FD_ZERO
(&
≈
->
wfds
);

38 
≈
->
maxfd
 = -1;

39 
	`‰ì
(
≈
->
ud
);

40 
≈
->
ud
 = 
NULL
;

41 
≈
->
maxfd
 = 0;

42 
	}
}

45 
	$_grow
(
≈_°©e
* 
≈
, 
maxfd
) {

46 
ˇp
 = 
≈
->cap;

47 
ˇp
 <
maxfd
)

48 
ˇp
 *= 2;

49 
≈
->
ud
 = 
	`ªÆloc
“p->ud, (*Ë* 
ˇp
);

50 
	`mem£t
(
≈
->
ud
 +Çp->
ˇp
, 0, (*) * (cap -Çp->cap));

51 
≈
->
ˇp
 = cap;

52 
	}
}

54 
ölöe
 
boﬁ


55 
	$_isvÆid_fd
(
fd
) {

62 i‡(
fd
 < 0)

63  
Ál£
;

64 #i‚de‡
WIN32


65 i‡(
fd
 >
FD_SETSIZE
)

66  
Ál£
;

68  
åue
;

69 
	}
}

72 
	$≈_add
(
≈_°©e
* 
≈
, 
fd
, 
mask
, * 
ud
) {

73 i‡(!
	`_isvÆid_fd
(
fd
)) {

76 
boﬁ
 
£t
 = 
Ál£
;

77 i‡(
mask
 & 
NP_RABLE
) {

78 
	`FD_SET
(
fd
, &
≈
->
rfds
);

79 
£t
 = 
åue
;

81 i‡(
mask
 & 
NP_WABLE
) {

82 
	`FD_SET
(
fd
, &
≈
->
wfds
);

83 
£t
 = 
åue
;

85 i‡(
£t
) {

86 i‡(
fd
 >
≈
->
ˇp
) {

87 
	`_grow
(
≈
, 
fd
);

89 
≈
->
ud
[
fd
] = ud;

90 i‡(
≈
->
maxfd
 < 
fd
)

91 
≈
->
maxfd
 = 
fd
;

94 
	}
}

97 
	$≈_mod
(
≈_°©e
* 
≈
, 
fd
, 
mask
, * 
ud
) {

98 i‡(!
	`_isvÆid_fd
(
fd
)) {

101 i‡(
mask
 & 
NP_RABLE
) {

102 
	`FD_SET
(
fd
, &
≈
->
rfds
);

104 
	`FD_CLR
(
fd
, &
≈
->
rfds
);

106 i‡(
mask
 & 
NP_WABLE
) {

107 
	`FD_SET
(
fd
, &
≈
->
wfds
);

109 
	`FD_CLR
(
fd
, &
≈
->
wfds
);

112 
	}
}

116 
	$≈_dñ
(
≈_°©e
* 
≈
, 
fd
) {

117 i‡(!
	`_isvÆid_fd
(
fd
)) {

120 
	`as£π
(
fd
 < 
≈
->
ˇp
);

121 
i
;

122 
	`FD_CLR
(
fd
, &
≈
->
rfds
);

123 
	`FD_CLR
(
fd
, &
≈
->
wfds
);

124 
≈
->
ud
[
fd
] = 
NULL
;

125 i‡(
fd
 =
≈
->
maxfd
) {

126 
i
 = 
≈
->
maxfd
-1; i>=0; --i) {

127 i‡(
≈
->
ud
[
i
]) {

131 
≈
->
maxfd
 = 
i
;

134 
	}
}

137 
	$≈_pﬁl
(
≈_°©e
* 
≈
, 
≈_evít
* 
e
, 
max
, 
timeout
) {

138 i‡(
≈
->
maxfd
 == -1)

140 
	`mem˝y
(&
≈
->
πmp
, &≈->
rfds
, (
fd_£t
));

141 
	`mem˝y
(&
≈
->
wtmp
, &≈->
wfds
, (
fd_£t
));

143 
timevÆ
 
tv
;

144 
timevÆ
* 
±v
 = 
NULL
;

145 i‡(
timeout
 >= 0) {

146 
tv
.
tv_£c
 = 
timeout
/1000;

147 
tv
.
tv_u£c
 = 
timeout
%1000*1000;

148 
±v
 = &
tv
;

150 
maxfd
 = 
≈
->maxfd;

151 
i
, 
n
 = 0;

152 
cou¡
 = 
	`£À˘
(
maxfd
+1, &
≈
->
πmp
, &≈->
wtmp
, 
NULL
, 
±v
);

153 i‡(
cou¡
 > 0) {

154 
i
=0; i<=
maxfd
; i++) {

155 
boﬁ
 
ªad
 = 
	`FD_ISSET
(
i
, &
≈
->
πmp
);

156 
boﬁ
 
wrôe
 = 
	`FD_ISSET
(
i
, &
≈
->
wtmp
);

157 i‡(
ªad
 || 
wrôe
) {

158 i‡(
≈
->
ud
[
i
]) {

159 
e
[
n
].
ud
 = 
≈
->ud[
i
];

160 
e
[
n
].
ªad
 =Ñead;

161 
e
[
n
].
wrôe
 = write;

162 
n
++;

167  
n
;

168 
	}
}

	@socket.c

1 
	~"√t.h
"

2 
	~"sockë.h
"

3 
	~"√çﬁl.h
"

4 
	~<as£π.h
>

5 
	~<°dlib.h
>

6 
	~<°rög.h
>

7 
	~<°dio.h
>

8 
	~<limôs.h
>

10 
	#STATUS_INVALID
 -1

	)

11 
	#STATUS_LISTENING
 1

	)

12 
	#STATUS_CONNECTING
 2

	)

13 
	#STATUS_CONNECTED
 3

	)

14 
	#STATUS_HALFCLOSE
 4

	)

15 
	#STATUS_SUSPEND
 5

	)

16 
	#STATUS_OPENED
 
STATUS_LISTENING


	)

18 
	#LISTEN_BACKLOG
 511

	)

19 
	#RBUFFER_SZ
 64

	)

21 
	#NETERR
(
îr
Ë”ºË!0 ? (îrË: 
NET_ERR_EOF
;

	)

23 c⁄° *
	gSTRERROR
[] = {

36 
	ssbuf„r
 {

37 
sbuf„r
 *
	m√xt
;

38 
	msz
;

39 *
	mbegö
;

40 *
	m±r
;

43 
	ssockë
 {

44 
sockë_t
 
	mfd
;

45 
	m°©us
;

46 
	mmask
;

47 
	mud©a
;

48 
sbuf„r
 *
	mhód
;

49 
sbuf„r
 *
	mèû
;

50 
	msbuf„rsz
;

51 
	mrbuf„rsz
;

52 
	m¶imô
;

55 
	s√t
 {

56 
≈_°©e
 
	m≈
;

57 
	mmax
;

58 
	mîr
;

59 
≈_evít
 *
	mi_evíts
;

60 
√t_evít
 *
	mo_evíts
;

61 
sockë
 *
	msockës
;

62 
sockë
 *
	m‰ì_sockë
;

63 
sockë
 *
	mèû_sockë
;

66 
ölöe
 
sockë
 *

67 
	$_sockë
(
√t
 *
£lf
, 
id
) {

68 
	`as£π
(
id
>=0 && id<
£lf
->
max
);

69 
sockë
 *
s
 = &
£lf
->
sockës
[
id
];

70  
s
->
°©us
 !
STATUS_INVALID
 ? s : 
NULL
;

71 
	}
}

74 
	$_subs¸ibe
(
√t
 *
£lf
, 
sockë
 *
s
, 
mask
) {

75 
ªsu…
;

76 i‡(
mask
 =
s
->mask)

78 i‡(
mask
 == 0)

79 
ªsu…
 = 
	`≈_dñ
(&
£lf
->
≈
, 
s
->
fd
);

80 i‡(
s
->
mask
 == 0)

81 
ªsu…
 = 
	`≈_add
(&
£lf
->
≈
, 
s
->
fd
, 
mask
, s);

83 
ªsu…
 = 
	`≈_mod
(&
£lf
->
≈
, 
s
->
fd
, 
mask
, s);

84 i‡(
ªsu…
 == 0)

85 
s
->
mask
 = mask;

86  
ªsu…
;

87 
	}
}

89 
sockë
*

90 
	$_Æloc_sockës
(
max
) {

91 
	`as£π
(
max
 > 0);

92 
i
;

93 
sockë
 *
s
 = 
	`mÆloc
(
max
*(socket));

94 
i
=0; i<
max
; ++i) {

95 
s
[
i
].
fd
 = i+1;

96 
s
[
i
].
°©us
 = 
STATUS_INVALID
;

97 
s
[
i
].
mask
 = 0;

98 
s
[
i
].
ud©a
 = -1;

99 
s
[
i
].
hód
 = 
NULL
;

100 
s
[
i
].
èû
 = 
NULL
;

101 
s
[
i
].
¶imô
 = 0;

102 
s
[
i
].
sbuf„rsz
 = 0;

104 
s
[
max
-1].
fd
 = -1;

105  
s
;

106 
	}
}

108 
sockë
*

109 
	$_¸óã_sockë
(
√t
 *
£lf
, 
sockë_t
 
fd
, 
¶imô
, 
ud©a
) {

110 
	`as£π
(
fd
 >= 0);

111 i‡(
£lf
->
‰ì_sockë
 =
NULL
)

112  
NULL
;

113 
sockë
 *
s
 = 
£lf
->
‰ì_sockë
;

114 i‡(
s
->
fd
 >= 0)

115 
£lf
->
‰ì_sockë
 = &£lf->
sockës
[
s
->
fd
];

117 
£lf
->
‰ì_sockë
 = 
NULL
;

118 
s
->
fd
 = fd;

119 
s
->
°©us
 = 
STATUS_SUSPEND
;

120 
s
->
mask
 = 0;

121 
s
->
ud©a
 = udata;

122 
s
->
hód
 = 
NULL
;

123 
s
->
èû
 = 
NULL
;

124 
s
->
sbuf„rsz
 = 0;

125 
s
->
rbuf„rsz
 = 
RBUFFER_SZ
;

126 
s
->
¶imô
 = slimit;

127 i‡(
s
->
¶imô
 <= 0)

128 
s
->
¶imô
 = 
INT_MAX
;

129  
s
;

130 
	}
}

133 
	$_˛o£_sockë
(
√t
 *
£lf
, 
sockë
 *
s
) {

134 i‡(
s
->
fd
 < 0) ;

135 
	`_subs¸ibe
(
£lf
, 
s
, 0);

136 
	`_sockë_˛o£
(
s
->
fd
);

137 
s
->
fd
 = -1;

138 
s
->
°©us
 = 
STATUS_INVALID
;

139 
s
->
ud©a
 = 0;

140 
s
->
hód
) {

141 
sbuf„r
 *
p
 = 
s
->
hód
;

142 
s
->
hód
 = s->hód->
√xt
;

143 
	`‰ì
(
p
->
begö
);

144 
	`‰ì
(
p
);

146 
s
->
èû
 = 
NULL
;

147 
s
->
sbuf„rsz
 = 0;

148 i‡(
£lf
->
‰ì_sockë
 =
NULL
) {

149 
£lf
->
‰ì_sockë
 = 
s
;

151 
	`as£π
(
£lf
->
èû_sockë
);

152 
	`as£π
(
£lf
->
èû_sockë
->
fd
 == -1);

153 
£lf
->
èû_sockë
->
fd
 = 
s
-£lf->
sockës
;

155 
£lf
->
èû_sockë
 = 
s
;

156 
	}
}

159 
	$√t_˛o£
(
√t
 *
£lf
, 
id
, 
f‹˚
) {

160 
sockë
 *
s
 = 
	`_sockë
(
£lf
, 
id
);

161 i‡(
s
 =
NULL
)  0;

162 i‡(
s
->
°©us
 =
STATUS_INVALID
)

164 i‡(
f‹˚
 || !
s
->
hód
) {

165 
	`_˛o£_sockë
(
£lf
, 
s
);

168 
s
->
°©us
 = 
STATUS_HALFCLOSE
;

171 
	}
}

174 
	$√t_subs¸ibe
(
√t
 *
£lf
, 
id
, 
ªad
) {

175 
sockë
 *
s
 = 
	`_sockë
(
£lf
, 
id
);

176 i‡(
s
 =
NULL
)  1;

177 
mask
 = 0;

178 i‡(
ªad
)

179 
mask
 |
NP_RABLE
;

180 i‡(
s
->
mask
 & 
NP_WABLE
)

181 
mask
 |
NP_WABLE
;

182  
	`_subs¸ibe
(
£lf
, 
s
, 
mask
);

183 
	}
}

185 
√t
*

186 
	$√t_¸óã
(
max
) {

187 i‡(
max
 <= 0)

188 
max
 = 1;

189 
√t
 *
£lf
 = 
	`mÆloc
((net));

190 i‡(
	`≈_öô
(&
£lf
->
≈
, 
max
)) {

191 
	`‰ì
(
£lf
);

192  
NULL
;

194 
£lf
->
max
 = max;

195 
£lf
->
îr
 = 0;

196 
£lf
->
i_evíts
 = 
	`mÆloc
(
max
*(
≈_evít
));

197 
£lf
->
o_evíts
 = 
	`mÆloc
(
max
*(
√t_evít
));

198 
£lf
->
sockës
 = 
	`_Æloc_sockës
(
max
);

199 
£lf
->
‰ì_sockë
 = &£lf->
sockës
[0];

200 
£lf
->
èû_sockë
 = &£lf->
sockës
[
max
-1];

201  
£lf
;

202 
	}
}

205 
	$√t_‰ì
(
√t
 *
£lf
) {

206 i‡(
£lf
 =
NULL
)

209 
i
;

210 
i
=0; i<
£lf
->
max
; ++i) {

211 
sockë
 *
s
 = &
£lf
->
sockës
[
i
];

212 i‡(
s
->
°©us
 >
STATUS_OPENED
) {

213 
	`_˛o£_sockë
(
£lf
, 
s
);

216 
	`‰ì
(
£lf
->
sockës
);

217 
£lf
->
‰ì_sockë
 = 
NULL
;

218 
£lf
->
èû_sockë
 = 
NULL
;

219 
	`‰ì
(
£lf
->
i_evíts
);

220 
	`‰ì
(
£lf
->
o_evíts
);

221 
	`≈_föi
(&
£lf
->
≈
);

222 
	`‰ì
(
£lf
);

223 
	}
}

226 
	$_ªad_˛o£
(
sockë
 *
s
) {

227 
buf
[1024];

229 
n
 = 
	`_sockë_ªad
(
s
->
fd
, 
buf
, (buf));

230 i‡(
n
 < 0) {

231 
îr
 = 
	`_sockë_gëîr‹
(
s
->
fd
);

232 i‡(
îr
 =
SEAGAIN
)  0;

233 i‡(
îr
 =
SEINTR
) ;

234  
	`NETERR
(
îr
);

235 } i‡(
n
 == 0) {

236  
NET_ERR_EOF
;

239 
	}
}

242 
	$√t_ªad
(
√t
 *
£lf
, 
id
, **
d©a
) {

243 
sockë
 *
s
 = 
	`_sockë
(
£lf
, 
id
);

244 i‡(
s
 =
NULL
)  -1;

245 i‡(
s
->
°©us
 =
STATUS_HALFCLOSE
) {

246 
£lf
->
îr
 = 
	`_ªad_˛o£
(
s
);

247 i‡(
£lf
->
îr
) {

248 
	`_˛o£_sockë
(
£lf
, 
s
);

252 
sz
 = 
s
->
rbuf„rsz
;

253 *
p
 = 
	`mÆloc
(
sz
);

255 
n
 = 
	`_sockë_ªad
(
s
->
fd
, 
p
, 
sz
);

256 i‡(
n
 < 0) {

257 
e
 = 
	`_sockë_gëîr‹
(
s
->
fd
);

258 i‡(
e
 =
SEAGAIN
) {

259 
	`‰ì
(
p
);

261 } i‡(
e
 =
SEINTR
) {

264 
	`‰ì
(
p
);

265 
	`_˛o£_sockë
(
£lf
, 
s
);

266 
£lf
->
îr
 = 
	`NETERR
(
e
);

269 } i‡(
n
 == 0) {

271 
	`‰ì
(
p
);

272 
	`_˛o£_sockë
(
£lf
, 
s
);

273 
£lf
->
îr
 = 
NET_ERR_EOF
;

276 i‡(
n
 =
s
->
rbuf„rsz
)

277 
s
->
rbuf„rsz
 <<= 1;

278 i‡(
s
->
rbuf„rsz
 > 
RBUFFER_SZ
 && 
n
 < (s->rbuffersz<<1))

279 
s
->
rbuf„rsz
 >>= 1;

280 *
d©a
 = 
p
;

281  
n
;

284 
	}
}

287 
	$_£nd_buf„r
(
√t
 *
£lf
, 
sockë
 *
s
) {

288 i‡(
s
->
hód
 =
NULL
)  0;

289 
s
->
hód
) {

290 
sbuf„r
 *
p
 = 
s
->
hód
;

292 
n
 = 
	`_sockë_wrôe
(
s
->
fd
, 
p
->
±r
,Ö->
sz
);

293 i‡(
n
 < 0) {

294 
e
 = 
	`_sockë_gëîr‹
(
s
->
fd
);

295 i‡(
e
 =
SEAGAIN
)  0;

296 i‡(
e
 =
SEINTR
) ;

297  
e
;

298 } i‡(
n
 == 0) {

300 } i‡(
n
 < 
p
->
sz
) {

301 
p
->
±r
 +
n
;

302 
p
->
sz
 -
n
;

303 
s
->
sbuf„rsz
 -
n
;

306 
s
->
sbuf„rsz
 -
n
;

310 
s
->
hód
 = 
p
->
√xt
;

311 
	`‰ì
(
p
->
begö
);

312 
	`‰ì
(
p
);

314 i‡(
s
->
hód
 =
NULL
)

315 
	`_subs¸ibe
(
£lf
, 
s
, s->
mask
 & (~
NP_WABLE
));

317 
	}
}

320 
	$√t_£nd
(
√t
* 
£lf
, 
id
, * 
d©a
, 
sz
, 
√t_evít
* 
evít
) {

321 
	`as£π
(
sz
 > 0);

322 
sockë
* 
s
 = 
	`_sockë
(
£lf
, 
id
);

323 i‡(
s
 =
NULL
) {

324 
	`‰ì
(
d©a
);

327 i‡(
s
->
°©us
 =
STATUS_HALFCLOSE
) {

328 
	`‰ì
(
d©a
);

331 
îr
;

332 i‡(
s
->
hód
 =
NULL
) {

333 *
±r
;

334 
n
 = 
	`_sockë_wrôe
(
s
->
fd
, 
d©a
, 
sz
);

335 i‡(
n
 >
sz
) {

336 
	`‰ì
(
d©a
);

338 } i‡(
n
 >= 0) {

339 
±r
 = (*)
d©a
 + 
n
;

340 
sz
 -
n
;

342 
±r
 = 
d©a
;

343 
îr
 = 
	`_sockë_gëîr‹
(
s
->
fd
);

344 
îr
) {

345 
SEAGAIN
: ;

346 
SEINTR
: ;

347 : 
îrout
;

350 
s
->
sbuf„rsz
 +
sz
;

351 i‡(
s
->
sbuf„rsz
 > s->
¶imô
) {

352 
îr
 = 
NET_ERR_WBUFOVER
;

353 
îrout
;

355 
sbuf„r
* 
p
 = 
	`mÆloc
((*p));

356 
p
->
√xt
 = 
NULL
;

357 
p
->
sz
 = sz;

358 
p
->
begö
 = 
d©a
;

359 
p
->
±r
 =Ötr;

361 
s
->
hód
 = s->
èû
 = 
p
;

362 
	`_subs¸ibe
(
£lf
, 
s
, s->
mask
|
NP_WABLE
);

365 
s
->
sbuf„rsz
 +
sz
;

366 i‡(
s
->
sbuf„rsz
 > s->
¶imô
) {

367 
îr
 = 
NET_ERR_WBUFOVER
;

368 
îrout
;

370 
sbuf„r
* 
p
 = 
	`mÆloc
((*p));

371 
p
->
√xt
 = 
NULL
;

372 
p
->
sz
 = sz;

373 
p
->
begö
 = 
d©a
;

374 
p
->
±r
 = 
d©a
;

376 
	`as£π
(
s
->
èû
 !
NULL
);

377 
	`as£π
(
s
->
èû
->
√xt
 =
NULL
);

378 
s
->
èû
->
√xt
 = 
p
;

379 
s
->
èû
 = 
p
;

382 
îrout
:

383 
	`‰ì
(
d©a
);

384 
evít
->
id
 = 
s
-
£lf
->
sockës
;

385 
evít
->
ty≥
 = 
NETE_SOCKERR
;

386 
evít
->
îr
 = 
	`NETERR
(err);

387 
evít
->
ud©a
 = 
s
->udata;

388 
	`_˛o£_sockë
(
£lf
, 
s
);

390 
	}
}

392 
sockë
 *

393 
	$_ac˚±
(
√t
 *
£lf
, 
sockë
 *
lis
) {

394 
sockë
 *
s
;

395 
sockaddr_ö
 
≥î
;

396 
sockÀn_t
 
l
 = (
≥î
);

397 
sockë_t
 
fd
 = 
	`ac˚±
(
lis
->fd, (
sockaddr
*)&
≥î
, &
l
);

398 i‡(
fd
 < 0)

399  
NULL
;

400 
s
 = 
	`_¸óã_sockë
(
£lf
, 
fd
, 
lis
->
¶imô
,Üis->
ud©a
);

401 i‡(
s
 =
NULL
) {

402 
	`_sockë_˛o£
(
fd
);

403  
NULL
;

405 i‡(
	`_sockë_n⁄blockög
(
fd
) == -1

407 
	`_˛o£_sockë
(
£lf
, 
s
);

408  
NULL
;

410 
s
->
°©us
 = 
STATUS_CONNECTED
;

411  
s
;

412 
	}
}

415 
	$√t_li°í
(
√t
 *
£lf
, c⁄° *
addr
, 
p‹t
, 
ud©a
) {

416 
addröfo
 
höts
;

417 
addröfo
 *
ªsu…
, *
Ω
;

418 
	`mem£t
(&
höts
, 0, (hints));

419 
höts
.
ai_Ámûy
 = 
AF_UNSPEC
;

420 
höts
.
ai_sockty≥
 = 
SOCK_STREAM
;

421 
höts
.
ai_¥Ÿocﬁ
 = 
IPPROTO_TCP
;

423 
•‹t
[16];

424 
	`¢¥ötf
(
•‹t
, (•‹t), "%u", 
p‹t
);

425 i‡(
	`gëaddröfo
(
addr
, 
•‹t
, &
höts
, &
ªsu…
)) {

426 
£lf
->
îr
 = 
NET_ERR_LISTEN
;

429 
fd
 = -1;

430 
£lf
->
îr
 = 0;

431 
Ω
 = 
ªsu…
;Ñp;Ñ∞Ω->
ai_√xt
) {

432 
fd
 = 
	`sockë
(
Ω
->
ai_Ámûy
,Ñp->
ai_sockty≥
,Ñp->
ai_¥Ÿocﬁ
);

433 i‡(
fd
 == -1)

435 i‡(
	`_sockë_n⁄blockög
(
fd
) == -1 ||

436 
	`_sockë_˛o£⁄exec
(
fd
) == -1 ||

437 
	`_sockë_ªu£addr
(
fd
) == -1) {

438 
£lf
->
îr
 = 
_sockë_îr‹
;

439 
	`_sockë_˛o£
(
fd
);

442 i‡(
	`böd
(
fd
, 
Ω
->
ai_addr
,Ñp->
ai_addæí
) == -1) {

443 
£lf
->
îr
 = 
_sockë_îr‹
;

444 
	`_sockë_˛o£
(
fd
);

445 
fd
 = -1;

450 i‡(
fd
 == -1) {

451 i‡(
£lf
->
îr
 == 0)

452 
£lf
->
îr
 = 
NET_ERR_LISTEN
;

453 
	`‰ìaddröfo
(
ªsu…
);

456 
£lf
->
îr
 = 0;

457 
	`‰ìaddröfo
(
ªsu…
);

459 i‡(
	`li°í
(
fd
, 
LISTEN_BACKLOG
) == -1) {

460 
£lf
->
îr
 = 
_sockë_îr‹
;

461 
	`_sockë_˛o£
(
fd
);

464 
sockë
 *
s
;

465 
s
 = 
	`_¸óã_sockë
(
£lf
, 
fd
, 0, 
ud©a
);

466 i‡(
s
 =
NULL
) {

467 
£lf
->
îr
 = 
NET_ERR_CREATESOCK
;

468 
	`_sockë_˛o£
(
fd
);

471 i‡(
	`_subs¸ibe
(
£lf
, 
s
, 
NP_RABLE
)) {

472 
£lf
->
îr
 = 
_sockë_îr‹
;

473 
	`_˛o£_sockë
(
£lf
, 
s
);

476 
s
->
°©us
 = 
STATUS_LISTENING
;

477  
s
 - 
£lf
->
sockës
;

478 
	}
}

480 
ölöe
 

481 
	$_⁄c⁄√˘
(
√t
 *
£lf
, 
sockë
 *
s
) {

482 
îr
;

483 
sockÀn_t
 
îæí
 = (
îr
);

484 i‡(
	`gësock›t
(
s
->
fd
, 
SOL_SOCKET
, 
SO_ERROR
, (*)&
îr
, &
îæí
) == -1) {

485 i‡(
îr
 == 0)

486 
îr
 = 
_sockë_îr‹
 != 0 ? _socket_error : -1;

488 i‡(
îr
 == 0) {

489 
s
->
°©us
 = 
STATUS_CONNECTED
;

490 
	`_subs¸ibe
(
£lf
, 
s
, 0);

493 
	`_˛o£_sockë
(
£lf
, 
s
);

494  
îr
;

496 
	}
}

499 
	$√t_c⁄√˘
(
√t
 *
£lf
, c⁄° *
addr
, 
p‹t
, 
block
, 
ud©a
) {

500 
£lf
->
îr
 = 0;

501 
addröfo
 
höts
;

502 
addröfo
 *
ªsu…
, *
Ω
;

503 
	`mem£t
(&
höts
, 0, (hints));

504 
höts
.
ai_Ámûy
 = 
AF_UNSPEC
;

505 
höts
.
ai_sockty≥
 = 
SOCK_STREAM
;

506 
höts
.
ai_¥Ÿocﬁ
 = 
IPPROTO_TCP
;

508 
•‹t
[16];

509 
	`¢¥ötf
(
•‹t
, (•‹t), "%u", 
p‹t
);

510 i‡(
	`gëaddröfo
(
addr
, 
•‹t
, &
höts
, &
ªsu…
)) {

511 
£lf
->
îr
 = 
NET_ERR_CONNECT
;

514 
fd
 = -1, 
°©us
;

515 
£lf
->
îr
 = 0;

516 
Ω
 = 
ªsu…
;Ñ∞!
NULL
;Ñ∞Ω->
ai_√xt
) {

517 
fd
 = 
	`sockë
(
Ω
->
ai_Ámûy
,Ñp->
ai_sockty≥
,Ñp->
ai_¥Ÿocﬁ
);

518 i‡(
fd
 == -1)

520 i‡(!
block
)

521 i‡(
	`_sockë_n⁄blockög
(
fd
) == -1) {

522 
£lf
->
îr
 = 
_sockë_îr‹
;

525 i‡(
	`c⁄√˘
(
fd
, 
Ω
->
ai_addr
,Ñp->
ai_addæí
) == -1) {

526 i‡(
block
) {

527 
£lf
->
îr
 = 
_sockë_îr‹
;

528 
	`_sockë_˛o£
(
fd
);

529 
fd
 = -1;

532 
îr
 = 
	`_sockë_gëîr‹
(
fd
);

533 i‡(!
	`SECONNECTING
(
îr
)) {

534 
£lf
->
îr
 =Érr;

535 
	`_sockë_˛o£
(
fd
);

536 
fd
 = -1;

540 
°©us
 = 
STATUS_CONNECTING
;

542 
°©us
 = 
STATUS_CONNECTED
;

544 i‡(
block
)

545 i‡(
	`_sockë_n⁄blockög
(
fd
) == -1) {

546 
£lf
->
îr
 = 
_sockë_îr‹
;

551 i‡(
fd
 == -1) {

552 i‡(
£lf
->
îr
 == 0)

553 
£lf
->
îr
 = 
NET_ERR_CONNECT
;

554 
	`‰ìaddröfo
(
ªsu…
);

557 
£lf
->
îr
 = 0;

558 
	`‰ìaddröfo
(
ªsu…
);

560 
sockë
 *
s
;

561 
s
 = 
	`_¸óã_sockë
(
£lf
, 
fd
, 0, 
ud©a
);

562 i‡(
s
 =
NULL
) {

563 
£lf
->
îr
 = 
NET_ERR_CREATESOCK
;

564 
	`_sockë_˛o£
(
fd
);

567 
s
->
°©us
 = status;

568 i‡(
s
->
°©us
 =
STATUS_CONNECTING
) {

569 i‡(
	`_subs¸ibe
(
£lf
, 
s
, 
NP_RABLE
|
NP_WABLE
)) {

570 
£lf
->
îr
 = 
_sockë_îr‹
;

571 
	`_˛o£_sockë
(
£lf
, 
s
);

574 
£lf
->
îr
 = 
NET_CONNECTING
;

576  
s
 - 
£lf
->
sockës
;

577 
	}
}

580 
	$√t_pﬁl
(
√t
 *
£lf
, 
timeout
, 
√t_evít
 **
evíts
) {

581 
√t_evít
 *
€
 = 
£lf
->
o_evíts
;;

582 
n
 = 
	`≈_pﬁl
(&
£lf
->
≈
, sñf->
i_evíts
, sñf->
max
, 
timeout
);

583 
i
;

584 
i
=0; i<
n
; ++i) {

585 
≈_evít
 *
õ
 = &
£lf
->
i_evíts
[
i
];

586 
sockë
 *
s
 = 
õ
->
ud
;

588 
s
->
°©us
) {

589 
STATUS_LISTENING
: {

590 
sockë
 *
lis
 = 
s
;

591 
s
 = 
	`_ac˚±
(
£lf
, 
lis
);

592 i‡(
s
) {

593 
€
->
ty≥
 = 
NETE_ACCEPT
;

594 
€
->
id
 = 
s
-
£lf
->
sockës
;

595 
€
->
ud©a
 = 
s
->udata;

596 
€
->
li°íid
 = 
lis
-
£lf
->
sockës
;

597 
€
++;

599 
STATUS_CONNECTING
:

600 i‡(
õ
->
wrôe
) {

601 
€
->
id
 = 
s
-
£lf
->
sockës
;

602 
€
->
ud©a
 = 
s
->udata;

603 
€
->
îr
 = 
	`_⁄c⁄√˘
(
£lf
, 
s
);

604 i‡(
€
->
îr
Ë€->
ty≥
 = 
NETE_CONNERR
;

605 i‡(
õ
->
ªad
Ë
€
->
ty≥
 = 
NETE_CONN_THEN_READ
;

606 
€
->
ty≥
 = 
NETE_CONNECT
;

607 
€
++;

610 
STATUS_CONNECTED
:

611 
STATUS_HALFCLOSE
:

612 i‡(
õ
->
wrôe
) {

613 
îr
 = 
	`_£nd_buf„r
(
£lf
, 
s
);

614 i‡(
îr
) {

615 
€
->
ty≥
 = 
NETE_SOCKERR
;

616 
€
->
id
 = 
s
-
£lf
->
sockës
;

617 
€
->
ud©a
 = 
s
->udata;

618 
€
->
îr
 =Érr;

619 
€
++;

620 
	`_˛o£_sockë
(
£lf
, 
s
);

623 i‡(
s
->
°©us
 =
STATUS_HALFCLOSE
 &&

624 
s
->
hód
 =
NULL
) {

625 
€
->
ty≥
 = 
NETE_WRIDONECLOSE
;

626 
€
->
id
 = 
s
-
£lf
->
sockës
;

627 
€
->
ud©a
 = 
s
->udata;

628 
€
++;

629 
	`_˛o£_sockë
(
£lf
, 
s
);

633 i‡(
õ
->
ªad
) {

634 
€
->
id
 = 
s
-
£lf
->
sockës
;

635 
€
->
ud©a
 = 
s
->udata;

636 
€
->
ty≥
 = 
NETE_READ
;

637 
€
++;

642 *
evíts
 = 
£lf
->
o_evíts
;

643  
€
 - 
£lf
->
o_evíts
;

644 
	}
}

647 
	$√t_addªss
(
√t
 *
£lf
, 
id
, 
√t_addr
 *
addr
) {

648 
sockë
 *
s
 = 
	`_sockë
(
£lf
, 
id
);

649 i‡(
s
 =
NULL
)  1;

650 
sockaddr_ö
 
≥î
;

651 
sockÀn_t
 
l
 = (
≥î
);

652 i‡(!
	`gë≥î«me
(
s
->
fd
, (
sockaddr
 *)&
≥î
, &
l
)) {

653 
	`öë_¡›
(
AF_INET
, &
≥î
.
sö_addr
, 
addr
->
ù
, (addr->ip));

654 
addr
->
p‹t
 = 
	`¡ohs
(
≥î
.
sö_p‹t
);

658 
	}
}

661 
	$√t_¶imô
(
√t
 *
£lf
, 
id
, 
¶imô
) {

662 
sockë
 *
s
 = 
	`_sockë
(
£lf
, 
id
);

663 i‡(
s
 =
NULL
)  1;

664 i‡(
¶imô
 < 0) slimit = 0;

665 
s
->
¶imô
 = slimit;

667 
	}
}

670 
	$√t_îr‹
(
√t
 *
£lf
, 
îr
) {

671 i‡(
îr
 <= 0) {

672 
îr
= -err;

673 i‡(
îr
<0 ||Éº>=(
STRERROR
)/(STRERROR[0]))

674 
îr
=0;

675  
STRERROR
[
îr
];

677  
	`_sockë_°ªº‹
(
îr
);

679 
	}
}

682 
	$√t_œ°î∫o
(
√t
 *
£lf
) {

683  
£lf
->
îr
;

684 
	}
}

	@socket.h

1 #i‚de‡
__NET_H__


2 
	#__NET_H__


	)

4 
	~<°döt.h
>

5 
	~"√t_deföe.h
"

7 
	g√t
;

8 
	g√t_evít
;

9 
	g√t_addr
;

11 
√t
 *
√t_¸óã
(
max
);

12 
√t_‰ì
(
√t
 *
£lf
);

14 
√t_li°í
(
√t
 *
£lf
, c⁄° *
addr
, 
p‹t
, 
ud©a
);

15 
√t_c⁄√˘
(
√t
 *
£lf
, c⁄° *
addr
, 
p‹t
, 
block
, 
ud©a
);

16 
√t_˛o£
(
√t
 *
£lf
, 
id
, 
f‹˚
);

17 
√t_subs¸ibe
(
√t
 *
£lf
, 
id
, 
ªad
);

18 
√t_pﬁl
(
√t
 *
£lf
, 
timeout
, 
√t_evít
 **
evíts
);

19 
√t_£nd
(
√t
 *
£lf
, 
id
, *
d©a
, 
sz
, 
√t_evít
 *
evít
);

20 
√t_ªad
(
√t
 *
£lf
, 
id
, **
d©a
);

21 
√t_addªss
(
√t
 *
£lf
, 
id
, 
√t_addr
 *
addr
);

22 
√t_¶imô
(
√t
 *
£lf
, 
id
, 
¶imô
);

23 
√t_œ°î∫o
(
√t
 *
£lf
);

24 c⁄° *
√t_îr‹
(
√t
 *
£lf
, 
îr
);

	@socket_define.h

1 #i‚de‡
__√t_def_h__


2 
	#__√t_def_h__


	)

4 
	~<°döt.h
>

6 
	#NETE_INVALID
 -1

	)

7 
	#NETE_READ
 0

	)

8 
	#NETE_ACCEPT
 1

	)

9 
	#NETE_CONNECT
 2

	)

10 
	#NETE_CONNERR
 3

	)

11 
	#NETE_SOCKERR
 4

	)

12 
	#NETE_WRIDONECLOSE
 5

	)

14 
	#NETE_CONN_THEN_READ
 6

	)

15 
	#NETE_TIMEOUT
 7

	)

16 
	#NETE_LOGOUT
 8

	)

17 
	#NETE_REDISREPLY
 9

	)

19 
	s√t_evít
 {

20 
	mid
;

21 
	mty≥
;

22 
	mud©a
;

24 
	mîr
;

25 
	mli°íid
;

31 
	#NET_ERR_EOF
 -1

	)

32 
	#NET_ERR_MSG
 -2

	)

33 
	#NET_ERR_NOSOCK
 -3

	)

34 
	#NET_ERR_CREATESOCK
 -4

	)

35 
	#NET_ERR_WBUFOVER
 -5

	)

36 
	#NET_ERR_NOBUF
 -6

	)

37 
	#NET_ERR_LISTEN
 -7

	)

38 
	#NET_ERR_CONNECT
 -8

	)

39 
	#NET_CONNECTING
 -9

	)

41 
	s√t_addr
 {

42 
	mù
[40];

43 
uöt16_t
 
	mp‹t
;

	@socket_platform.h

1 #i‚de‡
__sockë_h__


2 
	#__sockë_h__


	)

5 #ifde‡
WIN32


6 
	#WIN32_LEAN_AND_MEAN


	)

7 #i‚de‡
_WIN32_WINNT


8 
	#_WIN32_WINNT
 0x5001

10 
	~<wösock2.h
>

	)

11 
	~<ws2t˝ù.h
>

12 
	~<wödows.h
>

14 
	~<sys/ty≥s.h
>

15 
	~<sys/sockë.h
>

16 
	~<¨∑/öë.h
>

17 
	~<uni°d.h
>

18 
	~<f˙é.h
>

19 
	~<î∫o.h
>

20 
	~<√tdb.h
>

24 #i‚de‡
WIN32


25 
	#sockë_t
 

	)

26 
	#SOCKET_INVALID
 -1

	)

28 
	#sockë_t
 
SOCKET


29 
	#sockÀn_t
 

	)

30 
	#SOCKET_INVALID
 
INVALID_SOCKET


	)

34 #i‚de‡
WIN32


35 
	#SEINTR
 
EINTR


	)

36 
	#SEAGAIN
 
EAGAIN


	)

37 
	#SECONNECTING
(
e
Ë(”Ë=
EINPROGRESS
)

	)

39 
	#SEINTR
 
WSAEINTR


	)

40 
	#SEAGAIN
 
WSAEWOULDBLOCK


	)

41 
	#SECONNECTING
(
e
Ë(”Ë=
WSAEWOULDBLOCK
 || (eË=
WSAEINPROGRESS
)

	)

45 #i‚de‡
WIN32


46 
	#_sockë_îr‹
 
î∫o


	)

47 
	#_sockë_°ªº‹
(
e
Ë
	`°ªº‹
”)

	)

48 
	#_sockë_gëîr‹
(
fd
Ë
î∫o


	)

49 
	#_sockë_wrôe
(
fd
, 
buf
, 
sz
Ë
	`wrôe
(fd, buf, sz)

	)

50 
	#_sockë_ªad
(
fd
, 
buf
, 
sz
Ë
	`ªad
(fd, buf, sz)

	)

52 
	#_sockë_îr‹
 
	`WSAGëLa°Eº‹
()

	)

53 
	#_sockë_°ªº‹
(
e
Ë"sockëÉº‹"

	)

54 
ölöe
 
_sockë_gëîr‹
(
sockë_t
 
fd
);

55 
	#_sockë_wrôe
(
fd
, 
buf
, 
sz
Ë
	`£nd
(fd, buf, sz, 0)

	)

56 
	#_sockë_ªad
(
fd
, 
buf
, 
sz
Ë
	`ªcv
(fd, buf, sz, 0)

	)

60 #i‚de‡
WIN32


61 
ölöe
 

62 
	$_sockë_˛o£
(
sockë_t
 
fd
) {

63  
	`˛o£
(
fd
);

64 
	}
}

66 
ölöe
 

67 
	$_sockë_n⁄blockög
(
sockë_t
 
fd
) {

68 
Êag
 = 
	`f˙é
(
fd
, 
F_GETFL
, 0);

69 i‡(
Êag
 == -1)

71  
	`f˙é
(
fd
, 
F_SETFL
, 
Êag
 | 
O_NONBLOCK
);

72 
	}
}

74 
ölöe
 

75 
	$_sockë_˛o£⁄exec
(
sockë_t
 
fd
) {

76 
Êag
 = 
	`f˙é
(
fd
, 
F_GETFD
, 0);

77 i‡(
Êag
 == -1)

79  
	`f˙é
(
fd
, 
F_SETFD
, 
Êag
 | 
FD_CLOEXEC
);

80 
	}
}

82 
ölöe
 

83 
	$_sockë_ªu£addr
(
sockë_t
 
fd
) {

84 
ªu£
 = 1;

85  
	`£tsock›t
(
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, (*)&
ªu£
, (reuse));

86 
	}
}

89 
ölöe
 

90 
	$_sockë_˛o£
(
sockë_t
 
fd
) {

91  
	`˛o£sockë
(
fd
);

92 
	}
}

94 
ölöe
 

95 
	$_sockë_n⁄blockög
(
sockë_t
 
fd
) {

96 
u_l⁄g
 
n⁄blockög
 = 1;

97 i‡(
	`io˘lsockë
(
fd
, 
FIONBIO
, &
n⁄blockög
Ë=
SOCKET_ERROR
)

100 
	}
}

102 
ölöe
 

103 
	$_sockë_˛o£⁄exec
(
sockë_t
 
fd
) {

105 
	}
}

107 
ölöe
 

108 
	$_sockë_ªu£addr
(
sockë_t
 
fd
) {

110 
	}
}

112 
ölöe
 

113 
	$_sockë_gëîr‹
(
sockë_t
 
fd
) {

114 
›tvÆ
;

115 
sockÀn_t
 
›tvÆÀn
 = (
›tvÆ
);

116 
îr
 = 
	`WSAGëLa°Eº‹
();

117 i‡(
îr
 =
WSAEWOULDBLOCK
 && 
fd
 >= 0) {

118 i‡(
	`gësock›t
(
fd
, 
SOL_SOCKET
, 
SO_ERROR
, (*)&
›tvÆ
, &
›tvÆÀn
))

119  
îr
;

120 i‡(
›tvÆ
)

121  
›tvÆ
;

123  
îr
;

124 
	}
}

	@
1
.
1
/usr/include
11
121
cnet.c
cnet.h
lsocket.c
lsocket_buffer.c
np.h
np_epoll.h
np_select.h
socket.c
socket.h
socket_define.h
socket_platform.h
